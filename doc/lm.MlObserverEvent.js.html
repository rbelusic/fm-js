<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lm/ml/observers/lm.MlObserverEvent.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: lm/ml/observers/lm.MlObserverEvent.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
* Event ML observer class. Sends event to host.
* 
* Applicable on HTML nodes with &lt;click> event.
* 
* &lt;table>
* &lt;th>List of ML node attributes&lt;/th>
* &lt;tr>&lt;td>data-fmml-dom-event&lt;/td>&lt;td>DOM event which trigger FM event. Default is &lt;b>click&lt;/b> event&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-event-type&lt;/td>&lt;td>type (name) of event. In case of event type is not defined, successful action processing is triggered immediately&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-event-host&lt;/td>&lt;td>DOM node id of host which will receive event instead of default host&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-event-data&lt;/td>&lt;td>instead current host dmObject send FM.GenericValue object with this value&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-verify-observers&lt;/td>&lt;td>verify all observers first&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-event-async&lt;/td>&lt;td>Signals that event is async (AJAX request wil be triggered)&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-exec-on-success&lt;/td>&lt;td>code to exec when event is successfully completed&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-exec-on-error&lt;/td>&lt;td>code to exec when event error occurred&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-redirect-on-success&lt;/td>&lt;td>redirect to specified URL when event is successfully completed&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-redirect-on-error&lt;/td>&lt;td>redirect to specified URL when event error occurred&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-run-on-success&lt;/td>&lt;td>run host on DOM node with specified id when event is successfully completed&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-run-on-error&lt;/td>&lt;td>run host on DOM node with specified id when event error occurred&lt;/td>&lt;/tr>
* &lt;tr>&lt;td>data-fmml-send-form&lt;/td>&lt;td>send form on host node to URL specified in data-fmml-redirect-on-success node attribute. Host node type must be FORM&lt;/td>&lt;/tr>
* &lt;/table>
*
* On case of multiple actions defined on succes or on error, all of them will be executed in following order: 
*  data-fmml-exec-on-*, data-fmml-run-on-*, data-fmml-redirect-on-*
* 
* &lt;table>
* &lt;th>List of ML CSS classes&lt;/th>
* &lt;tr>&lt;td>fmmlWaitButton&lt;/td>&lt;td>Async event is in progress&lt;/td>&lt;/tr>
* &lt;/table>
* 
* @class FM.MlObserverEvent
* @extends FM.MlObserver
* @param {object} [attrs] DOM node attributes
* @param {DOMnode} node DOM node
*/    
FM.MlObserverEvent = FM.defineClass('MlObserverEvent',FM.MlObserver);

FM.MlObserverEvent.prototype._init = function(app,attrs,node) {
    this._super("_init",app,attrs,node);
    this.objectSubClass ="Event";

    this.eventHost = null;
    this.eventHostNode = null;
}


FM.MlObserverEvent.prototype.run = function() {
    this._super("run");
    
    var me = this;
    
    // dom event
    var evtrigger = this.getAttr('data-fmml-dom-event','click');

    $(this.node)[evtrigger](function(event) {
        event.preventDefault();
        
        // blur form change processing (bad, bad, bad)
        if(document.activeElement != this) { // this -> ev node
            document.activeElement.blur();
        }
        
        // my host & host node
        var myhost = me.getHost();
        var myhostnode = myhost ? myhost.getNode() : null;
        
        // obs verify
        if(myhost && me.getAttr('data-fmml-verify-observers','false') == 'true') {
            if(!myhost.verifyAllObservers(true)) {
                me.setLastError(new FM.DmGenericError({
                    messageId: 'UIVALIDATION',
                    text: 'Please enter all required fields'
                }));
                return false; // force validation of empty attributes
            }
        }
        
        // event host
        me.eventHost = null;
        me.eventHostNode = null;
        var evhostid = me.getAttr('data-fmml-event-host','');
        if(evhostid != '') {
            if(evhostid == 'parent' && myhostnode) {
                me.eventHostNode = FM.findNodeWithAttr(myhostnode.parentNode, "fmmlHost");
            } else {
                me.eventHostNode = FM.getNodeWithId(evhostid);
            }
            if (me.eventHostNode != null) {
                me.eventHost = FM.isset(me.eventHostNode.fmmlHost) ? me.eventHostNode.fmmlHost : null;
            }
            if(me.eventHost == null) me.eventHostNode = null;            
        } else {
            me.eventHost = myhost;    
            me.eventHostNode = myhostnode;    
        }
    
        // data to send
        var evdmobj = null;
        var evdata = me.getAttr('data-fmml-event-data','');
        if(evdata != '') {
            if(FM.startsWith(evdata,'@')) {
                evdata = me.resolveAttrValue("-",evdata);
            } 
            evdmobj = FM.isset(evdata) && evdata && FM.isset(evdata.getAttr) ? evdata : new FM.DmGenericValue({
                value: evdata
            });            
        } else {
            evdmobj = me.getDmObject();
        }

        // event to send
        var ev = me.getAttr('data-fmml-event-type','');
        
        // we are now ready to send
        if(ev && ev != '') {
            // set async class
            if(me.getAttr('data-fmml-event-async','false') === 'true') {
                $(me.node).addClass("fmmlWaitButton");
            }
            
            // clear old success & error hosts
            me._runHostOnNode(document.getElementById(me.getAttr('data-fmml-run-on-success','')),null);
            me._runHostOnNode(document.getElementById(me.getAttr('data-fmml-run-on-error','')),null);
            
            // send event
            me.eventHost.onEvent(me,ev,{
                object: evdmobj,
                callback: function(isok, o) {
                    me.eventCallback(isok, o);
                }
            });
        } else {
            me.eventCallback(true, null);
        }
        return false;
    });
}
 
FM.MlObserverEvent.prototype._runHostOnNode = function(hostnode,dmobj) {
    if(FM.isset(hostnode) && hostnode && FM.isset(hostnode.fmmlHost) && hostnode.fmmlHost) {
        hostnode.fmmlHost.run(dmobj);
    }
}

FM.MlObserverEvent.prototype._redirectToPage = function(url,dmobj) {
    var redirApl = FM.isset(url) && url && url != '' ?
         this.resolveAttrValue('-',FM.isset(dmobj) && dmobj ? FM.applyTemplate(dmobj.getAttr(),url) : url) : 
        ''
    ;
    window.location = redirApl;
}

FM.MlObserverEvent.prototype._sendFormToPage = function(url,dmobj) {
    if(!this.eventHost || !FM.isset(this.eventHostNode.submit)) return;
    
    var redirApl = FM.isset(url) && url && url != '' ?
         this.resolveAttrValue('-',FM.isset(dmobj) && dmobj ? FM.applyTemplate(dmobj.getAttr(),url) : url) : 
        ''
    ;
    
    this.eventHostNode.action = redirApl;
    this.eventHostNode.submit();    
}
            
FM.MlObserverEvent.prototype._execCode = function(code,dmobj) {
    try {
        var val = FM.resolveAttrValue(this.options,"-", code,{
            A: this.getApp(),
            H: this.getHost(),
            O: this,
            D: dmobj
        });
    } catch(e) {
        this.log(e,FM.logLevels.error,'MlObserverEvent._execCode');
    }
}

FM.MlObserverEvent.prototype.eventCallback = function(isok,oResponse) {
    // remove async class 
    $(this.node).removeClass("fmmlWaitButton");

    // exec
    var code = isok ?
        this.getAttr('data-fmml-exec-on-success','') :
        this.getAttr('data-fmml-exec-on-error','')
    ;
    if(code != '') {
        this._execCode(code,oResponse);
    }
    
    // host run
    var hostid = isok ?
        this.getAttr('data-fmml-run-on-success','') :
        this.getAttr('data-fmml-run-on-error','')
    ;
    if(hostid != '') {
        this._runHostOnNode(document.getElementById(hostid),oResponse);
    }        

    // redirect
    var redir = isok ?
        this.getAttr('data-fmml-redirect-on-success','') :
        this.getAttr('data-fmml-redirect-on-error','')
    ;
    if(redir != '') {
        if(this.getAttr('data-fmml-send-form','false') == 'true') {
            this._sendFormToPage(redir,oResponse);
        } else{
            this._redirectToPage(redir,oResponse);
        }
    }
}

FM.MlObserver.addObserver("Event",FM.MlObserverEvent,'GLOBAL');
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="FM.AppObject.html">AppObject</a></li><li><a href="FM.DmGenericError.html">DmGenericError</a></li><li><a href="FM.DmGenericValue.html">DmGenericValue</a></li><li><a href="FM.DmList.html">DmList</a></li><li><a href="FM.DmObject.html">DmObject</a></li><li><a href="FM.DmTranslation.html">DmTranslation</a></li><li><a href="FM.LmObject.html">LmObject</a></li><li><a href="FM.MlAttributeEdit.html">MlAttributeEdit</a></li><li><a href="FM.MlDateAttributeEdit.html">MlDateAttributeEdit</a></li><li><a href="FM.MlDateFormat.html">MlDateFormat</a></li><li><a href="FM.MlExtension.html">MlExtension</a></li><li><a href="FM.MlHost.html">MlHost</a></li><li><a href="FM.MlHostGenericCollection.html">MlHostGenericCollection</a></li><li><a href="FM.MlHostQueryParams.html">MlHostQueryParams</a></li><li><a href="FM.MlListOfValues.html">MlListOfValues</a></li><li><a href="FM.MlObserver.html">MlObserver</a></li><li><a href="FM.MlObserverAttribute.html">MlObserverAttribute</a></li><li><a href="FM.MlObserverDisplay.html">MlObserverDisplay</a></li><li><a href="FM.MlObserverEvent.html">MlObserverEvent</a></li><li><a href="FM.MlObserverListIndex.html">MlObserverListIndex</a></li><li><a href="FM.MlObserverListOrder.html">MlObserverListOrder</a></li><li><a href="FM.MlObserverListSelection.html">MlObserverListSelection</a></li><li><a href="FM.MlObserverListState.html">MlObserverListState</a></li><li><a href="FM.MlTypeaheadMenu.html">MlTypeaheadMenu</a></li><li><a href="FM.Object.html">Object</a></li><li><a href="FM.TstAjax.html">TstAjax</a></li><li><a href="FM.TstDmList.html">TstDmList</a></li><li><a href="FM.TstGeneric.html">TstGeneric</a></li><li><a href="FM.UtAjax.html">UtAjax</a></li><li><a href="FM.UtRegistry.html">UtRegistry</a></li><li><a href="FM.UtTemplate.html">UtTemplate</a></li><li><a href="FM.UtTimer.html">UtTimer</a></li><li><a href="FM.UtTimerJob.html">UtTimerJob</a></li><li><a href="FM.UtTranslations.html">UtTranslations</a></li></ul><h3>Events</h3><ul><li><a href="FM.DmList.html#event:onAjaxStateEnd">onAjaxStateEnd</a></li><li><a href="FM.DmList.html#event:onAjaxStateError">onAjaxStateError</a></li><li><a href="FM.DmList.html#event:onAjaxStateStart">onAjaxStateStart</a></li></ul><h3>Namespaces</h3><ul><li><a href="namespace.html">Basic SDK namespace</a></li><li><a href="FM.MlObserver.validationRules.html">validationRules</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Sat Sep 28 2013 21:01:02 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
