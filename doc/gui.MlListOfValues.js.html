<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: gui/ml/gui.MlListOfValues.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: gui/ml/gui.MlListOfValues.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
* ML list of values edit extensions class. 
* 
* @class FM.MlListOfValues
* @extends FM.MlExtension
* @param {object} [attrs] DOM node attributes
* @param {DOMnode} node DOM node
*/
FM.MlListOfValues = FM.defineClass('MlListOfValues',FM.MlExtension);

FM.MlListOfValues.prototype._init = function(attrs,node) {
    this._super("_init",attrs,node);
    this.objectSubClass = "ListOfValues";
    this.lastLovArguments = null;
    this.lovDependsOf = null;
    this.lovItemsTemplate = null;
    this.dmList = null;
}


/*
 * data-fmml-list               - dm list conf
 * data-fmml-list-id-attr       - list attr which correspond to attr of observer
 * data-fmml-list-id            - menu id attr
 * data-fmml-list-text-attr     - menu text attr
 * data-fmml-list-def-selected  - menu def value
 * data-fmml-list-def-selected-attr -
 * data-fmml-list-allow-null    - add empty row in menu
 * data-fmml-list-depends-of    - list of host attributes to send
 */

// methods
// fetch values for LOV from server
FM.MlListOfValues.prototype.lovFetch = function(args,callback) {
    
    // get observer
    var obs = this.getObserver();
    if(!obs) {
        return false;
    }
    
    // create dmlist
    args = FM.isset(args) && args && FM.isObject(args) ? args : {};
    callback = FM.isset(callback) && callback && FM.isFunction(callback) ? callback: function() {};
    var dmconfName = obs.getAttr('data-fmml-list','');
    if(this.dmList) {
        this.dmList.dispose();
    }
    this.dmList = new FM.DmList(args,dmconfName,obs.getApp());
    this.lastLovArguments = args;
    
    // prepare listener
    var me = this;
    var lstnr = {
        /** @ignore */
        onListStart: function(sender,data) {
            me.log("Ajax call started",FM.logLevels.info,'MlListOfValues.onListStart');
            $(me.getNode()).addClass("fmmlWaitState");
            return true;
        },
        /** @ignore */
        onListEnd: function(sender,data) {
            me.log("Ajax call completed",FM.logLevels.info,'MlListOfValues.onListEnd');
            $(me.getNode()).removeClass("fmmlWaitState");
            me.dmList.removeListener(lstnr);    
            callback(true,me.dmList);
            return true;
        },
        /** @ignore */
        onListError: function(sender,data) {
            me.log(data,FM.logLevels.error,'MlListOfValues.onListError');
            $(me.getNode()).removeClass("fmmlWaitState");
            me.dmList.removeListener(lstnr);    
            callback(false,null);
            return true;
        }
    };
    
    me.dmList.addListener(lstnr);
    me.dmList.getData();

    return true; 
}


FM.MlListOfValues.prototype.lovRenderItem = function(obj,issel,menuId,menuAttr,menuTempl,menuTemplName) {
    var itmText = '';
    var me = this;
    if(menuTemplName != '') {
        if(me.lovItemsTemplate == null) {
            FM.UtTemplate.getTemplate(this.getApp(),obj.getAttr(),menuTemplName,function(isok,templ) {            
                if(isok) {
                    me.lovItemsTemplate = templ;
                } else {
                    me.lovItemsTemplate = '';
                }
                var attrs = obj.getAttr();
                attrs['lovSelected'] = issel ? 'selected' : '';
                attrs['lovValue'] = obj.getAttr(menuId,'');
                attrs['lovDataID'] = obj.getDataID();
                itmText = $(FM.applyTemplate(attrs, me.lovItemsTemplate, false, false));
                $(itmText).attr("data-fmml-object-id",obj.getDataID());
                $(me.getNode()).append(itmText);  
            });   
            return;
        } else {
            var attrs = obj.getAttr();
            attrs['lovSelected'] = issel ? 'selected' : '';
            attrs['lovValue'] = obj.getAttr(menuId,'');
            attrs['lovDataID'] = obj.getDataID();
            itmText = FM.applyTemplate(attrs, this.lovItemsTemplate, false, false);
        }
    
    } else if(menuTempl != '') {
        itmText = 
            '&lt;option ' + 
            (issel ? 'selected="selected"' : '') + 
            ' value="' + obj.getAttr(menuId,'') + '">' +
            FM.applyTemplate(obj.getAttr(), menuTempl, false, false) +
            '&lt;/option>'
        ;
    } else {
        itmText = 
            '&lt;option ' + 
            (issel ? 'selected="selected"' : '') + 
            ' value="' + obj.getAttr(menuId,'') + '">' +
            obj.getAttr(menuAttr,'') +
            '&lt;/option>'
        ;
    }

    itmText = $(itmText);
    $(itmText).attr("data-fmml-object-id",obj.getDataID());
    $(this.getNode()).append(itmText);        
}

FM.MlListOfValues.prototype.lovDisplay = function(isok, dmList) {    
    // clear list
    $(this.getNode()).empty();
    
    // get observer & dmobject & obs attribute name
    var me = this;
    var obs = this.getObserver();
    var dmobj = this.getDmObject();
    var attr = obs.getAttr('data-fmml-attr-name','');
    
    // LOV def data-fmml-list-id-attr > data-fmml-attr-name ref!
    var menuId = obs.getAttr('data-fmml-list-id-attr','id');
    var menuAttr = obs.getAttr('data-fmml-list-text-attr','');        
    var menuTempl = obs.getAttr('data-fmml-list-text-template','');        
    var menuTemplName = obs.getAttr('data-fmml-list-text-template-name','');        
    var defSelValue = obs.getAttr('data-fmml-list-def-selected','');
    if(FM.isFunction(window[defSelValue])) defSelValue = window[defSelValue](); // ref!
    var defSelAttr = obs.getAttr('data-fmml-list-def-selected-attr','');
    var allowNulls = obs.getAttr('data-fmml-list-allow-null','false');

    // state
    var def=null,first = null,cur=null;    
    var curVal = dmobj ? dmobj.getAttr(attr,'') : '';
    
    // ok, display list
    if(isok) {
        // null
        if(allowNulls == 'true') {
            $(thisgetNode()).append('&lt;option value="">&lt;/option>');
        }

        // iterate list and find sel value
        dmList.forEachListElement(function(index,obj) {
            // def
            if(defSelAttr != '' && defSelValue!='') {
                if(obj.getAttr(defSelAttr,'') == defSelValue) {
                    def = obj;
                }
            }
            if(!first) {
                first = obj;
            }
            if(obj.getAttr(menuId,'') == curVal) {
                cur = obj;
            }
            return(true);
        });
        
        // find selected (current > def > first > none
        var lovSelected = cur ? cur : (def ? def : first);

        // fill list
        dmList.forEachListElement(function(index,obj) {
            me.lovRenderItem(obj,obj == lovSelected,menuId,menuAttr,menuTempl,menuTemplName);
            return(true);
        });
        
        // start listener
        $(me.getNode()).change(function() {
            // attribute to set
            var dmobj = obs.getDmObject();
            var value = $(me.getNode()).val();
            if(FM.isset(attr) && attr && attr != '' && dmobj && dmobj.getAttr(attr) !== value) {
                dmobj.setAttr(attr,value,true);
            }
            
            // host to run
            var hostToRun = me.getAttr("data-fmml-run-on-lov-change",'');
            if(hostToRun != '') {
                var node = document.getElementById(hostToRun);
                if( node) {
                    var optNode = $(me.getNode()).find(":selected");
                    optNode = optNode.length > 0 ? optNode[0] : null;
                    if(optNode) {
                        var lovObj = dmList.get($(optNode).attr("data-fmml-object-id"));
                        me._runHost(node,lovObj,true);
                    }
                }
            }
        });
        $(me.getNode()).change();
        
        // check if dm value and lov value are the same                
        if(lovSelected) {
            if(dmobj && dmobj.getAttr(attr,'') != lovSelected.getAttr(menuId,'')) {
                dmobj.setAttr(attr,lovSelected.getAttr(menuId,''),true);            
            }
        }
           
    } else { // error
        $(me.getNode()).append('&lt;option value="">&lt;i>Error occured&lt;/i>&lt;/option>');        
    }    
}

FM.MlListOfValues.prototype._runHost = function(node,oObj,doinit) {    
    if(!FM.isset(node) || !node) return false;
    doinit = doinit == true;
    
    if(!FM.isset(node.fmmlHost) || !node.fmmlHost) {
        if(!doinit || !$(node).attr('data-fmml-host')) return false;
        FM.MlHost.initChildNodes(this.getApp(),node,oObj,false);
        if(!FM.isset(node.fmmlHost) || !node.fmmlHost) return false;
    }
    
    node.fmmlHost.run(oObj);
    return true;
}

FM.MlListOfValues.prototype.lovGetFetchArguments = function() {
    var args = {};
    var obs = this.getObserver();    
    var dmobj = obs.getDmObject();
    if(dmobj) for(var i = 0; i &lt; this.lovDependsOf.length; i++) {
        args[this.lovDependsOf[i]] = dmobj.getAttr(this.lovDependsOf[i],'');
    }    
    return args;    
}


FM.MlListOfValues.prototype.lovCheckDepedOfChanged = function() {    
    var obs = this.getObserver();    
    var dmobj = obs.getDmObject();

    // menu is not filled yet
    if(!dmobj || this.lastLovArguments == null) return true;
    
    
    // check attributes
    var depchanged = false;
    for(var i = 0; i &lt; this.lovDependsOf.length; i++) {
        if(
            FM.getAttr(this.lastLovArguments,this.lovDependsOf[i],'') 
            != 
            dmobj.getAttr(this.lovDependsOf[i],'')
            ) {
            depchanged = true;
            break;
        }
    }
    
    // end
    return(depchanged);
}


FM.MlListOfValues.prototype.run = function(obs) {
    this._super("run",obs);
    
    // if dependsof attrs are not jet collected 
    var dependsOfStr = obs.getAttr('data-fmml-list-depends-of','');
    this.lovDependsOf = dependsOfStr == '' ? [] : dependsOfStr.split(',');

    // create LOV
    var me = this;
    this.lovFetch(this.lovGetFetchArguments(), function(isok, list) {
        me.lovDisplay(isok, list);
    });
}


FM.MlListOfValues.prototype.dispose = function(obs) {
    if(this.getNode()) $(this.getNode()).unbind();
    this._super("dispose");
}

FM.MlListOfValues.prototype.update = function(obs) {
    this._super("update",obs);

    // if dep value are not changed
    if(!this.lovCheckDepedOfChanged()) {
        return true;
    }
    
    var me = this;
    this.lovFetch(this.lovGetFetchArguments(), function(isok, list) {
        me.lovDisplay(isok, list);
    });
}


// static
FM.MlExtension.addExtensionType('MlListOfValues', FM.MlListOfValues);




</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="FM.AppObject.html">AppObject</a></li><li><a href="FM.DmGenericError.html">DmGenericError</a></li><li><a href="FM.DmGenericValue.html">DmGenericValue</a></li><li><a href="FM.DmList.html">DmList</a></li><li><a href="FM.DmObject.html">DmObject</a></li><li><a href="FM.DmTranslation.html">DmTranslation</a></li><li><a href="FM.LmObject.html">LmObject</a></li><li><a href="FM.MlAttributeEdit.html">MlAttributeEdit</a></li><li><a href="FM.MlDateAttributeEdit.html">MlDateAttributeEdit</a></li><li><a href="FM.MlDateFormat.html">MlDateFormat</a></li><li><a href="FM.MlExtension.html">MlExtension</a></li><li><a href="FM.MlHost.html">MlHost</a></li><li><a href="FM.MlHostGenericCollection.html">MlHostGenericCollection</a></li><li><a href="FM.MlHostQueryParams.html">MlHostQueryParams</a></li><li><a href="FM.MlListOfValues.html">MlListOfValues</a></li><li><a href="FM.MlObserver.html">MlObserver</a></li><li><a href="FM.MlObserverAttribute.html">MlObserverAttribute</a></li><li><a href="FM.MlObserverDisplay.html">MlObserverDisplay</a></li><li><a href="FM.MlObserverEvent.html">MlObserverEvent</a></li><li><a href="FM.MlObserverListIndex.html">MlObserverListIndex</a></li><li><a href="FM.MlObserverListOrder.html">MlObserverListOrder</a></li><li><a href="FM.MlObserverListSelection.html">MlObserverListSelection</a></li><li><a href="FM.MlObserverListState.html">MlObserverListState</a></li><li><a href="FM.MlTypeaheadMenu.html">MlTypeaheadMenu</a></li><li><a href="FM.Object.html">Object</a></li><li><a href="FM.TstAjax.html">TstAjax</a></li><li><a href="FM.TstDmList.html">TstDmList</a></li><li><a href="FM.TstGeneric.html">TstGeneric</a></li><li><a href="FM.UtAjax.html">UtAjax</a></li><li><a href="FM.UtRegistry.html">UtRegistry</a></li><li><a href="FM.UtTemplate.html">UtTemplate</a></li><li><a href="FM.UtTimer.html">UtTimer</a></li><li><a href="FM.UtTimerJob.html">UtTimerJob</a></li><li><a href="FM.UtTranslations.html">UtTranslations</a></li></ul><h3>Events</h3><ul><li><a href="FM.DmList.html#event:onAjaxStateEnd">onAjaxStateEnd</a></li><li><a href="FM.DmList.html#event:onAjaxStateError">onAjaxStateError</a></li><li><a href="FM.DmList.html#event:onAjaxStateStart">onAjaxStateStart</a></li></ul><h3>Namespaces</h3><ul><li><a href="namespace.html">Basic SDK namespace</a></li><li><a href="FM.MlObserver.validationRules.html">validationRules</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Sat Sep 28 2013 21:01:02 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
